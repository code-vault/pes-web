import type { NextRequest } from 'next/server';
import { NextResponse } from 'next/server';
import sgMail from '@sendgrid/mail';

// Initialize SendGrid
if (process.env.SENDGRID_API_KEY) {
  sgMail.setApiKey(process.env.SENDGRID_API_KEY);
}

type RouteContext = {
  params: Promise<{ locale: string }>;
};

interface ContactFormData {
  firstName: string;
  lastName: string;
  email: string;
  phone: string;
  address: string;
  bill?: string;
  additional?: string;
  submittedAt: string;
  language: string;
  source: string;
}

// Validation functions
const validateEmail = (email: string): boolean => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
};

const validatePhone = (phone: string): boolean => {
  const phoneRegex = /^(\+91|91)?[\s-]?[6-9]\d{9}$/;
  return phoneRegex.test(phone.replace(/[\s-]/g, ''));
};

const sanitizeInput = (input: string): string => {
  return input.trim().replace(/[<>]/g, '');
};

// Email Templates
const getAdminEmailTemplate = (formData: ContactFormData) => {
  const isHindi = formData.language === 'hi';
  
  return `
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <title>${isHindi ? 'рдирдИ рд╕реЛрд▓рд░ рдЗрдВрдХреНрд╡рд╛рдпрд░реА' : 'New Solar Inquiry'}</title>
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .header { background: linear-gradient(135deg, #f97316, #f59e0b); color: white; padding: 20px; text-align: center; }
            .content { padding: 20px; background: #f9fafb; }
            .info-card { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            .label { font-weight: bold; color: #374151; }
            .value { color: #6b7280; margin-left: 10px; }
            .priority { background: #fef2f2; border: 1px solid #fecaca; padding: 15px; border-radius: 8px; margin: 20px 0; }
            .footer { text-align: center; padding: 20px; color: #6b7280; font-size: 14px; }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>ЁЯМЮ ${isHindi ? 'рдирдИ рд╕реЛрд▓рд░ рдЗрдВрдХреНрд╡рд╛рдпрд░реА!' : 'New Solar Inquiry!'}</h1>
            <p>${isHindi ? 'рдПрдХ рдирдпрд╛ рдЧреНрд░рд╛рд╣рдХ рд╕реЛрд▓рд░ рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди рдореЗрдВ рд░реБрдЪрд┐ рд░рдЦрддрд╛ рд╣реИ' : 'A new customer is interested in solar installation'}</p>
        </div>
        
        <div class="content">
            <div class="priority">
                <h3>тЪб ${isHindi ? 'рддреБрд░рдВрдд рдлреЙрд▓реЛ-рдЕрдк рдХрд░реЗрдВ!' : 'Follow up immediately!'}</h3>
                <p>${isHindi ? 'рдпрд╣ рдПрдХ рдЧрд░реНрдо рд▓реАрдб рд╣реИ - 24 рдШрдВрдЯреЗ рдХреЗ рднреАрддрд░ рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдВ' : 'This is a warm lead - contact within 24 hours'}</p>
            </div>
            
            <div class="info-card">
                <h3>${isHindi ? 'рдЧреНрд░рд╛рд╣рдХ рдЬрд╛рдирдХрд╛рд░реА' : 'Customer Information'}</h3>
                <p><span class="label">${isHindi ? 'рдирд╛рдо:' : 'Name:'}</span><span class="value">${formData.firstName} ${formData.lastName}</span></p>
                <p><span class="label">${isHindi ? 'рдИрдореЗрд▓:' : 'Email:'}</span><span class="value">${formData.email}</span></p>
                <p><span class="label">${isHindi ? 'рдлреЛрди:' : 'Phone:'}</span><span class="value">${formData.phone}</span></p>
                <p><span class="label">${isHindi ? 'рдкрддрд╛:' : 'Address:'}</span><span class="value">${formData.address}</span></p>
            </div>
            
            <div class="info-card">
                <h3>${isHindi ? 'рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╡рд┐рд╡рд░рдг' : 'Project Details'}</h3>
                <p><span class="label">${isHindi ? 'рдорд╛рд╕рд┐рдХ рдмрд┐рд▓:' : 'Monthly Bill:'}</span><span class="value">${formData.bill || (isHindi ? 'рдкреНрд░рджрд╛рди рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛' : 'Not provided')}</span></p>
                <p><span class="label">${isHindi ? 'рдЕрддрд┐рд░рд┐рдХреНрдд рдЬрд╛рдирдХрд╛рд░реА:' : 'Additional Info:'}</span><span class="value">${formData.additional || (isHindi ? 'рдХреЛрдИ рдирд╣реАрдВ' : 'None')}</span></p>
                <p><span class="label">${isHindi ? 'рднрд╛рд╖рд╛ рдкреНрд░рд╛рдердорд┐рдХрддрд╛:' : 'Language Preference:'}</span><span class="value">${formData.language === 'hi' ? 'рд╣рд┐рдВрджреА' : 'English'}</span></p>
            </div>
            
            <div class="info-card">
                <h3>${isHindi ? 'рд╕рдмрдорд┐рд╢рди рд╡рд┐рд╡рд░рдг' : 'Submission Details'}</h3>
                <p><span class="label">${isHindi ? 'рд╕рдмрдорд┐рдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛:' : 'Submitted:'}</span><span class="value">${new Date(formData.submittedAt).toLocaleString()}</span></p>
                <p><span class="label">${isHindi ? 'рд╕реНрд░реЛрдд:' : 'Source:'}</span><span class="value">${formData.source}</span></p>
            </div>
        </div>
        
        <div class="footer">
            <p>${isHindi ? 'рдкреВрд░реНрд╡реЛрджрдп рдПрдирд░реНрдЬреА рд╕реЙрд▓реНрдпреВрд╢рдВрд╕ - рд▓реАрдб рдореИрдиреЗрдЬрдореЗрдВрдЯ рд╕рд┐рд╕реНрдЯрдо' : 'Purvodaya Energy Solutions - Lead Management System'}</p>
        </div>
    </body>
    </html>
  `;
};

const getCustomerEmailTemplate = (formData: ContactFormData) => {
  const isHindi = formData.language === 'hi';
  
  return `
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <title>${isHindi ? 'рдЖрдкрдХреА рд╕реЛрд▓рд░ рдЗрдВрдХреНрд╡рд╛рдпрд░реА рдкреНрд░рд╛рдкреНрдд рд╣реБрдИ' : 'Your Solar Inquiry Received'}</title>
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .header { background: linear-gradient(135deg, #f97316, #f59e0b); color: white; padding: 30px; text-align: center; }
            .content { padding: 30px; background: #f9fafb; }
            .welcome { background: white; padding: 20px; border-radius: 12px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
            .next-steps { background: #ecfdf5; border: 1px solid #10b981; padding: 20px; border-radius: 12px; margin: 20px 0; }
            .contact-info { background: white; padding: 20px; border-radius: 12px; margin: 20px 0; }
            .footer { text-align: center; padding: 20px; color: #6b7280; }
            .button { display: inline-block; background: linear-gradient(135deg, #f97316, #f59e0b); color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 10px 5px; }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>ЁЯМЮ ${isHindi ? 'рдзрдиреНрдпрд╡рд╛рдж, ' + formData.firstName + '!' : 'Thank you, ' + formData.firstName + '!'}</h1>
            <p>${isHindi ? 'рдЖрдкрдХреА рд╕реЛрд▓рд░ рдЗрдВрдХреНрд╡рд╛рдпрд░реА рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкреНрд░рд╛рдкреНрдд рд╣реБрдИ рд╣реИ' : 'Your solar inquiry has been successfully received'}</p>
        </div>
        
        <div class="content">
            <div class="welcome">
                <h2>${isHindi ? 'рдЖрдкрдХреА рд╕реМрд░ рдпрд╛рддреНрд░рд╛ рд╢реБрд░реВ рд╣реЛ рдЧрдИ рд╣реИ!' : 'Your Solar Journey Begins!'}</h2>
                <p>${isHindi ? 
                  'рд╣рдореЗрдВ рдЦреБрд╢реА рд╣реИ рдХрд┐ рдЖрдкрдиреЗ рд╕реНрд╡рдЪреНрдЫ, рдирд╡реАрдХрд░рдгреАрдп рдКрд░реНрдЬрд╛ рдореЗрдВ рд░реБрдЪрд┐ рджрд┐рдЦрд╛рдИ рд╣реИред рд╣рдорд╛рд░реА рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ рдЯреАрдо рдЖрдкрдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдПрдХ рдХрд╕реНрдЯрдо рд╕реЛрд▓рд░ рд╕рдорд╛рдзрд╛рди рддреИрдпрд╛рд░ рдХрд░реЗрдЧреАред' : 
                  'We\'re excited that you\'re interested in clean, renewable energy. Our expert team will prepare a custom solar solution tailored to your needs.'
                }</p>
            </div>
            
            <div class="next-steps">
                <h3>ЁЯУЛ ${isHindi ? 'рдЕрдЧрд▓реЗ рдХрджрдо:' : 'Next Steps:'}</h3>
                <ul>
                    <li>${isHindi ? 'тЬЕ рдЖрдкрдХреА рдЬрд╛рдирдХрд╛рд░реА рдХреА рд╕рдореАрдХреНрд╖рд╛ (1-2 рдШрдВрдЯреЗ)' : 'тЬЕ Review your information (1-2 hours)'}</li>
                    <li>${isHindi ? 'ЁЯУЮ рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ рдЖрдкрдХреЛ рдХреЙрд▓ рдХрд░реЗрдВрдЧреЗ (24 рдШрдВрдЯреЗ рдХреЗ рднреАрддрд░)' : 'ЁЯУЮ Our expert will call you (within 24 hours)'}</li>
                    <li>${isHindi ? 'ЁЯПа рдореБрдлреНрдд рд╕рд╛рдЗрдЯ рд╕рд░реНрд╡реЗ рд╢реЗрдбреНрдпреВрд▓ рдХрд░рдирд╛' : 'ЁЯПа Schedule free site survey'}</li>
                    <li>${isHindi ? 'ЁЯТ░ рдХрд╕реНрдЯрдо рдХреЛрдЯреЗрд╢рди рддреИрдпрд╛рд░ рдХрд░рдирд╛' : 'ЁЯТ░ Prepare custom quotation'}</li>
                </ul>
            </div>
            
            <div class="contact-info">
                <h3>${isHindi ? 'рддреБрд░рдВрдд рд╕рд╣рд╛рдпрддрд╛ рдЪрд╛рд╣рд┐рдП?' : 'Need Immediate Assistance?'}</h3>
                <p>${isHindi ? 'рд╣рдорд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░рдиреЗ рдореЗрдВ рд╕рдВрдХреЛрдЪ рди рдХрд░реЗрдВ:' : 'Don\'t hesitate to contact us:'}</p>
                
                <a href="tel:+919876543210" class="button">ЁЯУЮ ${isHindi ? 'рдЕрднреА рдХреЙрд▓ рдХрд░реЗрдВ' : 'Call Now'}</a>
                <a href="https://wa.me/919876543210" class="button">ЁЯТм WhatsApp</a>
                
                <p style="margin-top: 20px;">
                    <strong>${isHindi ? 'рдлреЛрди:' : 'Phone:'}</strong> +91 98765 43210<br>
                    <strong>${isHindi ? 'рдИрдореЗрд▓:' : 'Email:'}</strong> info@purvodayaenergy.com<br>
                    <strong>${isHindi ? 'рд╕рдордп:' : 'Hours:'}</strong> ${isHindi ? 'рд╕реЛрдорд╡рд╛рд░-рд╢рдирд┐рд╡рд╛рд░ 9AM-6PM' : 'Mon-Sat 9AM-6PM'}
                </p>
            </div>
        </div>
        
        <div class="footer">
            <p>${isHindi ? 'рдзрдиреНрдпрд╡рд╛рдж,' : 'Thank you,'}<br>
            <strong>${isHindi ? 'рдкреВрд░реНрд╡реЛрджрдп рдПрдирд░реНрдЬреА рд╕реЙрд▓реНрдпреВрд╢рдВрд╕ рдЯреАрдо' : 'Purvodaya Energy Solutions Team'}</strong></p>
            <p style="font-size: 12px; color: #9ca3af;">
                ${isHindi ? 'рдпрд╣ рдПрдХ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдИрдореЗрд▓ рд╣реИред рдХреГрдкрдпрд╛ рдЗрд╕рдХрд╛ рдЙрддреНрддрд░ рди рджреЗрдВред' : 'This is an automated email. Please do not reply.'}
            </p>
        </div>
    </body>
    </html>
  `;
};

// Send emails function
async function sendEmails(formData: ContactFormData) {
  if (!process.env.SENDGRID_API_KEY) {
    console.log('SendGrid not configured, skipping email send');
    return;
  }

  const adminEmail = {
    to: process.env.EMAIL_TO || 'leads@purvodayaenergy.com',
    from: process.env.EMAIL_FROM || 'noreply@purvodayaenergy.com',
    subject: `ЁЯМЮ New Solar Lead: ${formData.firstName} ${formData.lastName} (${formData.bill ? formData.bill + ' monthly bill' : 'No bill info'})`,
    html: getAdminEmailTemplate(formData)
  };

  const customerEmail = {
    to: formData.email,
    from: process.env.EMAIL_FROM || 'noreply@purvodayaenergy.com',
    subject: formData.language === 'hi' 
      ? `рдзрдиреНрдпрд╡рд╛рдж ${formData.firstName}! рдЖрдкрдХреА рд╕реЛрд▓рд░ рдЗрдВрдХреНрд╡рд╛рдпрд░реА рдкреНрд░рд╛рдкреНрдд рд╣реБрдИ` 
      : `Thank you ${formData.firstName}! Your Solar Inquiry Received`,
    html: getCustomerEmailTemplate(formData)
  };

  try {
    // Send admin notification
    await sgMail.send(adminEmail);
    console.log('Admin notification sent successfully');

    // Send customer confirmation
    await sgMail.send(customerEmail);
    console.log('Customer confirmation sent successfully');

  } catch (error) {
    console.error('Email sending failed:', error);
    // Don't throw error - we don't want to fail the API call if email fails
  }
}

// Main API handler
export async function POST(
  request: NextRequest,
  context: RouteContext
) {
  try {
    const { locale } = await context.params;
    
    // Parse the request body
    const rawData = await request.json();
    
    // Validate required fields
    const requiredFields = ['firstName', 'lastName', 'email', 'phone', 'address'];
    const missingFields = requiredFields.filter(field => !rawData[field]?.trim());
    
    if (missingFields.length > 0) {
      return NextResponse.json(
        { 
          message: locale === 'hi' 
            ? `рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлрд╝реАрд▓реНрдб рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВ: ${missingFields.join(', ')}`
            : `Missing required fields: ${missingFields.join(', ')}`,
          error: 'VALIDATION_ERROR',
          missingFields
        }, 
        { status: 400 }
      );
    }

    // Validate email format
    if (!validateEmail(rawData.email)) {
      return NextResponse.json(
        { 
          message: locale === 'hi' 
            ? 'рдХреГрдкрдпрд╛ рдПрдХ рд╡реИрдз рдИрдореЗрд▓ рдкрддрд╛ рджрд░реНрдЬ рдХрд░реЗрдВ'
            : 'Please enter a valid email address',
          error: 'INVALID_EMAIL'
        }, 
        { status: 400 }
      );
    }

    // Validate phone format
    if (!validatePhone(rawData.phone)) {
      return NextResponse.json(
        { 
          message: locale === 'hi' 
            ? 'рдХреГрдкрдпрд╛ рдПрдХ рд╡реИрдз рдлреЛрди рдирдВрдмрд░ рджрд░реНрдЬ рдХрд░реЗрдВ'
            : 'Please enter a valid phone number',
          error: 'INVALID_PHONE'
        }, 
        { status: 400 }
      );
    }

    // Sanitize and structure the form data
    const formData: ContactFormData = {
      firstName: sanitizeInput(rawData.firstName),
      lastName: sanitizeInput(rawData.lastName),
      email: sanitizeInput(rawData.email),
      phone: sanitizeInput(rawData.phone),
      address: sanitizeInput(rawData.address),
      bill: rawData.bill ? sanitizeInput(rawData.bill) : '',
      additional: rawData.additional ? sanitizeInput(rawData.additional) : '',
      submittedAt: rawData.submittedAt || new Date().toISOString(),
      language: locale,
      source: rawData.source || 'website_contact_form'
    };

    console.log('Contact form submission received:', {
      name: `${formData.firstName} ${formData.lastName}`,
      email: formData.email,
      phone: formData.phone,
      language: formData.language,
      timestamp: formData.submittedAt
    });

    // Send emails (admin notification + customer confirmation)
    await sendEmails(formData);

    // Success response
    return NextResponse.json({ 
      message: locale === 'hi' 
        ? `рдзрдиреНрдпрд╡рд╛рдж ${formData.firstName}! рдЖрдкрдХрд╛ рд╕рдВрджреЗрд╢ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкреНрд░рд╛рдкреНрдд рд╣реБрдЖ рд╣реИред рд╣рдорд╛рд░реА рдЯреАрдо 24 рдШрдВрдЯреЗ рдХреЗ рднреАрддрд░ рдЖрдкрд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░реЗрдЧреАред`
        : `Thank you ${formData.firstName}! Your message has been received successfully. Our team will contact you within 24 hours.`,
      success: true,
      data: {
        submissionId: `PES-${Date.now()}`,
        estimatedResponseTime: '24 hours'
      }
    });

  } catch (error) {
    console.error('Contact API Error:', error);
    
    const url = new URL(request.url);
    const locale = url.pathname.includes('/hi/') ? 'hi' : 'en';
    
    return NextResponse.json({ 
      message: locale === 'hi'
        ? 'рдХреНрд╖рдорд╛ рдХрд░реЗрдВ, рдПрдХ рддрдХрдиреАрдХреА рд╕рдорд╕реНрдпрд╛ рд╣реБрдИ рд╣реИред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ рдпрд╛ рд╣рдореЗрдВ +91 98765 43210 рдкрд░ рдХреЙрд▓ рдХрд░реЗрдВред'
        : 'Sorry, there was a technical issue. Please try again or call us at +91 98765 43210.',
      error: 'INTERNAL_SERVER_ERROR'
    }, { status: 500 });
  }
}

// Health check endpoint
export async function GET(
  request: NextRequest,
  context: RouteContext
) {
  try {
    const { locale } = await context.params;
    
    return NextResponse.json({
      status: 'ok',
      message: locale === 'hi' ? 'рд╕рдВрдкрд░реНрдХ API рдХрд╛рд░реНрдпрд░рдд рд╣реИ' : 'Contact API is working',
      emailConfigured: !!process.env.SENDGRID_API_KEY,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    return NextResponse.json({
      status: 'error',
      message: 'API health check failed'
    }, { status: 500 });
  }
}